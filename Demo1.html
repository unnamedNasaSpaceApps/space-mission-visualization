<!DOCTYPE html>
<head>
        <meta http-equiv="X-UA-Compatible" content="chrome=1" />
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<title>Trajectory from GMAT</title>
		<meta name="author" content="Daniel A. O'Neil">
		<meta name="copyright" content="? Daniel A. O'Neil" />
	<style>
	  p.case { clear: both; border-top: 0px; solid: #fff; }
	</style>
	<link rel="stylesheet" type="text/css" href="x3dom.css" />
	<script src="mission1.js" type="text/javascript"></script>
</head>
<body>

<h2>Prototype Web Visualization of a GMAT Generated Trajectory</h2>

	<p class="case"> 
		<X3D xmlns="http://www.web3d.org/specifications/x3d-namespace" showStat="false" showLog="false" x="0px" y="0px" width="800px" height="600px">
          <Scene>
			<background DEF='bgnd' transparency='0' skyColor='0.0 0.0 0.0' ></background>
		</Transform>
		<Transform id="theCenter" translation="0 0 0" rotation="1 0 0 3.3"></Transform>
		<Transform id="theEarth" translation="0 0 0" rotation="-2 -1 1 1.401426" >  <!-- rotation="0 0 1 0.401426" -->
			   <Transform id="continents" translation="0 0 0" rotation="0 0 0 1.401426">
			   <Shape>
				 <Appearance>
					 <Material diffuseColor='1 1 1'></Material>
					 <ImageTexture url='https://media.discordapp.net/attachments/381484701874913293/1160390836937314355/image.png?ex=65347d2e&is=6522082e&hm=2615fcc802906f18336f3d410292870f8bd8a7d7be22cb8c13a457cf2112e7f2&=&width=1344&height=671'/>
				 </Appearance>
				 <Sphere radius='0.65'/> <!-- was 0.63781 -->
			  </Shape>
			</Transform>
		</Transform>
	 </Transform>
		   <Viewpoint fieldOfView="0.785398" position="6 5.5 6.5" orientation="1 -1 0 -0.785"  description=""/>
          </Scene>
        </X3D>
    </p>
	
	<p class="case" align="center">
	
<p id="demo"></p>

<script>
	var rotAngle = 0 ;                    // accrued rotation angle for the Earth
	var simSpeed = 10 
	showValue(1) ;  
	var step = 0 ;

function updateRotationStats() {
   var earthRotations = rotAngle / 6.28 ;
   
   document.getElementById("rotationStats").textContent =
   "Earth rotations =  " + Math.abs(earthRotations.toFixed(2));
 
 }

 function showValue(newValue)
{  // Read a simulation speed setting from a slider control.
	 simSpeed = newValue * 0.01;    // was 0.01
}

function updateHBPositions() 
	{  
	  // updateTheDate() ;            // Display the date progression starting from the current epoch.

	 // Earth rotation rate 
	  var earthRotationRate = 0.0000727221; // radians/second
	  
	   var earthRotationRate = 0.069; // radians/cycle
	  rotAngle = rotAngle + earthRotationRate  * simSpeed;
	  console.log(rotAngle);
	 document.getElementById("continents").setAttribute('rotation',0 + " " + 1 + " " + 0 + " " + rotAngle) ;
	  updateRotationStats() ;              // write the number of rotations for the earth 
	  
	};

var mission = JSON.parse(trajectory) ;

// function traceTrajectory(theMission)  
//	{  // Generate line segments from points around the trajectory of the orbiting objects.
	   // Trace the orbits for the following array of objects.
	   var segIndex = 0 ;   // segment counter
	   var orbitCoords = "" ;
	for (var segment in mission.coordinates) {
		
		var s = document.createElement('Shape');            // Shape Node
		s.setAttribute("id", "segment" + segIndex);

		var app = document.createElement('Appearance');     // Appearance Node
		var mat = document.createElement('Material');       // Material Node
		   mat.setAttribute("id", "Mat" + segIndex);
		   mat.setAttribute("diffuseColor", 1 + " " + 0 + " " + 0);
		   mat.setAttribute("emissiveColor", 1 + " " + 0 + " " + 0.3);
		app.appendChild(mat);
		s.appendChild(app);
		
		var segCoords = [mission.coordinates[segment].X/10000, mission.coordinates[segment].Y/10000, mission.coordinates[segment].Z/10000] ;
		console.log("x  " + segCoords[0] + "  y  " + segCoords[1] + "  z  " + segCoords[2]) ;
		
		orbitCoords = orbitCoords + segCoords[0]  + " " + segCoords[1]  + " " + segCoords[2]  + " " ;
		
		var line = document.createElement('IndexedLineSet');
        line.setAttribute("coordIndex", segIndex);
		var coords = document.createElement('Coordinate');
		coords.setAttribute("point", orbitCoords);
		
		line.appendChild(coords) ;
		
		s.appendChild(line);
		var ot = document.getElementById('theCenter');
        ot.appendChild(s);
		
		segIndex = segIndex + 1 ;
		setInterval(function () {updateHBPositions() }, 100);
	 }

	 

	 /*-----------------------------
	 *  Create a satellite model 
	 *----------------------------*/
	 var pos = [mission.coordinates[0].X/10000, mission.coordinates[0].Y/10000, mission.coordinates[0].Z/10000] 
	  var t = document.createElement('Transform');
        t.setAttribute("translation", pos[0] + " " + pos[1] + " " + pos[2] );
        t.setAttribute("id", 'satPosition');
		
		var satellite = document.createElement('Shape');        // Shape Node for satellite
		satellite.setAttribute("id", "satellite");

		var satapp = document.createElement('Appearance');     // Appearance Node
		var satmat = document.createElement('Material');       // Material Node
		   satmat.setAttribute("id", "SatMat");
		   satmat.setAttribute("diffuseColor", 0 + " " + 1 + " " + 0);
		   satmat.setAttribute("emissiveColor", 0 + " " + 1 + " " + 0.3);
		satapp.appendChild(satmat);
		satellite.appendChild(satapp);
		
		var satmodel = document.createElement('Box');
		satmodel.setAttribute("size", 0.2 + " " + 0.2 + " " + 0.2);
		/*var satmodel = document.createElement('Inline') ;
		satmodel.setAttribute('url', "TrianaSatellite.x3d") ;*/
		// satellite.setAttribute("id", "sat1");
		satellite.appendChild(satmodel);
		t.appendChild(satellite) ;
		
		var objsat = document.getElementById('theCenter');
        objsat.appendChild(t);

		setInterval(function () {updatePosition() }, 50);

	   function updatePosition()   {
 // for (segment in mission.coordinates) {
  //    pos = [mission.coordinates[segment].X/10000, mission.coordinates[segment].Y/10000, mission.coordinates[segment].Z/10000] ;
     pos = [mission.coordinates[step].X/10000, mission.coordinates[step].Y/10000, mission.coordinates[step].Z/10000] ;
	  var Xpos = pos[0] ;
	  var Ypos = pos[1] ;
	  var Zpos = pos[2] ;
      document.getElementById('satPosition').setAttribute('translation', Xpos + " " + Ypos + " " + Zpos);
	  console.log("x  " + Xpos + "  y  " + Ypos + "  z  " + Zpos) ;
		
/*document.getElementById("demo").textContent = 
                        "Date:  " + mission.coordinates[step].Date + "  Time: " + mission.coordinates[step].Time;*/
 
 //  }
 step = step + 1 ;
 }; 

  function resetPosition() {
    step = 0 ;
	pos = [mission.coordinates[step].X/10000, mission.coordinates[step].Y/10000, mission.coordinates[step].Z/10000] ;
	  var Xpos = pos[0] ;
	  var Ypos = pos[1] ;
	  var Zpos = pos[2] ;
      document.getElementById('satPosition').setAttribute('translation', Xpos + " " + Ypos + " " + Zpos);
	  
	  setInterval(function () {updatePosition() }, 60);
 } ;

 
 // };

 // traceTrajectory(mission)  ;
  
document.getElementById("demo").textContent =
"Mission Start Date: " +
mission.coordinates[0].Date + "  " +
mission.coordinates[0].Time + "\r\n" +
"Mission End Date: " + 
mission.coordinates[154].Date + "  " +
mission.coordinates[154].Time ;

</script>
<script type="text/javascript" src="x3dom.js"></script>
<input type="button" id="reset" value="Reset" onclick="resetPosition();" />
<input type="file" id="fileInput">
<br>
<p style="width:800px">
Using time-stamped Cartesian coordinate data generated from NASA's General Mission Analysis Tool (GMAT), this
interactive visualization depicts an orbital trajectory as a red dashed ellipse with a blue sphere located at
one of the foci. The can be rotated by holding down the left mouse button and dragging the mouse. The scene can
panned by holding down the middle mouse button and dragging the mouse. Use the middle mouse wheel to zoom-in
or zoom-out of the scene.
</p>
</body>
</html>
